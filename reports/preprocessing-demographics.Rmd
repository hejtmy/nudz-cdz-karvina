---
title: "preprocessing"
author: "Lukáš 'hejtmy' Hejtmánek"
date: "12/02/2021"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(lmerTest)
library(lme4)
source("../functions/cdz-preprocess.R")
knitr::opts_chunk$set(echo = TRUE)
```

Loading the already prepared files. THe results are loaded and analyzed results form the supermarket, the demographics are from the online google sheet at [ID CDZ](https://docs.google.com/spreadsheets/d/1qMdiLYY7EIbNvoRsE5knjBB24zXT7hgJNUCmwMX7IwY/edit#gid=0) from sheet demografie, the ids are data from the same file and sheet ID, the rbans from the same file sheet RBANS, the sessions are used to determine timestamps for each individual session and are loaded from this google sheet [sessions](https://docs.google.com/spreadsheets/d/1rFm8QnjGw3BQuFfMvGiLUa5hMvg3-8iTP8h5DGMZLlc/edit#gid=0). The files are loaded from prepared csv files generated by scripts in the `scripts/` folder. The df_results are already joined with the df_sessions from the preprocessing stage (see file `scripts/run2-results-output.R`)
```{r loading}
df_results <- read.table("../run2-results-supermarket-sessions.csv", sep = ";",
                         header = TRUE)

df_demographics <- read.table("../demographics.csv", sep = ";", header = TRUE)
df_ids <- read.table("../information.csv", header = TRUE, sep = ";")
df_sessions <- read.table("../sessions.csv", header = TRUE, sep = ";")
df_rbans <- read.table("../rbans.csv", sep=";", header = TRUE)
```

## Data joining and combining

### Supermarket

The supermarket has `r length(unique(df_results$participant))` participants before join.
```{r adding demographics to supermarket}
# Combine with demographics
df_join <- df_demographics %>%
  left_join(df_ids, by = "rbansid") %>%
  select(rbansid, vrid) %>% 
  filter(!is.na(rbansid) & !is.na(vrid))
df_results <- df_results %>%
  left_join(df_join, by = c("participant" = "vrid"))
rm(df_join)
```

And it has `r length(unique(df_results$participant))` after the join. We then add new variables such as correct ratio etc.

```{r adding supermarket metrics}
df_results <- df_results %>%
  mutate(total_picked_items = n_correct_items + n_extra_items,
         correct_ratio = n_correct_items/n_items,
         extra_ratio = n_extra_items/n_items) %>%
  group_by(participant, session) %>%
  mutate(n_trials = n()) %>%
  ungroup()
```

### Rbans
We first add a session to rbans data based on the df_demographics sheet. The RBANS sheet does NOT have session value, it only has if participant did TP or VR prior to that version, so we need to figure out what was their first and second training.

```{r}
df_rbans <- add_session_to_rbans(df_rbans, df_demographics)
```

Then we calculate the individual scores for each category. These are prefixed by `dim_` prefix, where the original scores are prefixed with `iq_`.
```{r}
df_rbans <- add_summaries_to_rbans(df_rbans)
```

## Outlier and participant removal

We remove the first session and all sessions above 12 from the supermarket data

```{r}
# First session was supposedly weird, and only few people did more than 12
df_results <- filter(df_results, session <= 12, session > 1)
```

And filter for different versions of supermarket tests. Remediation used different verion of the settings than test verion
```{r}
df_results_remediation <- filter(df_results, type == "remediation")
df_results_test <- filter(df_results, type == "test")
```

Usually participants have one fewer session due to us discarding the session number 1, but overall they all have 12 sessions completed.

```{r}
df_results_remediation %>%
  group_by(participant) %>%
  summarise(n_sessions = length(unique(session)),
            max_session = max(session)) %>%
    pivot_longer(cols = c(max_session, n_sessions)) %>%
    ggplot(aes(participant, value, fill = name)) +
      geom_col(position = "dodge") +
      coord_flip() + labs(title = "Number of valid sessions and maximum achieved session")
```

```{r}
df_results_remediation %>%
  group_by(participant) %>%
  summarise(n_sessions = length(unique(session)),
            max_session = max(session)) %>%
    pivot_longer(cols = c(max_session, n_sessions)) %>%
    group_by(name) %>%
    count(value) %>%
    knitr::kable(col.names = c("", "value", "Number of participants"), 
                 caption = "Number of participants with given number of valid sessions")
```

## Final sample

The final RBANS counts look like this
```{r rbansfinal, message=FALSE}
df_rbans %>%
  group_by(rbansid) %>%
  summarise(n_sessions = sum(!is.na(testuceni)), .groups="drop") %>%
  count(n_sessions) %>%
  knitr::kable(col.names =  c("RBANS completed", "Number of subjects"))

df_rbans %>%
  group_by(trenink) %>%
  summarise(n_sessions = sum(!is.na(testuceni))) %>%
  knitr::kable(col.names =  c("trenink", "Number of subjects"))

df_rbans %>%
  group_by(session) %>%
  summarise(n_sessions = sum(!is.na(testuceni))) %>%
  knitr::kable(col.names =  c("Session", "Number of subjects"))

df_rbans %>%
  filter(session == 1) %>%
  group_by(first_training) %>%
  summarise(n_sessions = sum(!is.na(testuceni))) %>%
  knitr::kable(col.names =  c("First Training", "Number of subjects"))
```

Combining the rbans with supermarket to get the "cross" results - only people who have both the supermarket data and the rbans data to acompany it

```{r}
df_check_complete <- df_results_remediation %>%
  select(participant, rbansid) %>%
  distinct %>%
  left_join(filter(df_rbans, trenink == "VR")) %>%
  filter(!is.na(testuceni)) %>%
  select(participant, rbansid, session)
```

That is `r nrow(df_check_complete)` people who have both. 

```{r}
df_check_complete %>%
  group_by(session) %>%
  count() %>%
  knitr::kable(caption = "Number of peopel who have VR in each session")
```
